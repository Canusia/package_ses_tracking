{% extends "cis/logged-base.html" %}
{% block title %}{{page_title}}{% endblock %}

{% block body %}
<style>

</style>
<main>
    <div class="">
        <div class="row">
            <div class="col-sm-6 col-xs-12">
                <h1 class="h3 mb-4 text-gray-800">{{page_title}}</h1>
            </div>
        </div>

        
        <div class="row">
            <div class="col-md-12">
                {% include "cis/messages.html" with messages=messages %}

                <ul class="nav nav-tabs">
                    <li class="nav-item">
                        <a data-bs-toggle="tab" data-bs-target="#all" type="button" role="tab" aria-controls="all"
                            aria-selected="false" class="nav-link active" href="#all">All {{page_title}}</a>
                    </li>
                </ul>


                <div class="tab-content">
                    <div class="tab-pane active show" id="all">
                        
                        <div class="bg-white border border-top-0">
                            <div class="col-12 pt-3 mb-3">

                                <div class="row">                                    
                                    <div class="col-md-12 mb-3">
                        <div class="">
                            <div class="mt-2">
                                <style>
        .container {
            margin-top: 30px;
        }
        .stats-card {
            margin-bottom: 20px;
        }
        .rate-good {
            color: #28a745;
            font-weight: bold;
        }
        .rate-warning {
            color: #ffc107;
            font-weight: bold;
        }
        .rate-danger {
            color: #dc3545;
            font-weight: bold;
        }
    </style>
    <!-- Date Range Filter -->
        <div class="row mb-3">
            <div class="col-md-4">
                <label for="startDate">Start Date:</label>
                <input type="date" id="startDate" class="form-control">
            </div>
            <div class="col-md-4">
                <label for="endDate">End Date:</label>
                <input type="date" id="endDate" class="form-control">
            </div>
            <div class="col-md-4">
                <label>&nbsp;</label>
                <button id="filterBtn" class="btn btn-primary d-block">Filter</button>
            </div>
        </div>
        
        <!-- DataTable -->
        <table id="statsTable" class="table table-striped table-bordered dt-responsive nowrap" style="width:100%">
            <thead>
                <tr>
                    <th>Date</th>
                    <!-- <th>Sends</th> -->
                    <th>Deliveries</th>
                    <th>Bounces</th>
                    <th>Complaints</th>
                    <th>Bounce Rate</th>
                    <th>Complaint Rate</th>
                    <!-- <th>Delivery Rate</th> -->
                    <th>Recipients</th>
                </tr>
            </thead>
        </table>

    <script>
        $(document).ready(function() {
            // Get CSRF token if needed
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            
            const csrftoken = getCookie('csrftoken');
            
            // Initialize DataTable
            var table = $('#statsTable').DataTable({
                processing: true,
                serverSide: true,
                responsive: true,
                ajax: {
                    url: '{{api_url}}',
                    type: 'GET',
                    data: function(d) {
                        // Add custom date filters
                        var startDate = $('#startDate').val();
                        var endDate = $('#endDate').val();
                        
                        if (startDate) {
                            d.start_date = startDate;
                        }
                        if (endDate) {
                            d.end_date = endDate;
                        }
                        
                        return d;
                    },
                    dataSrc: 'data',
                    headers: {
                        'X-CSRFToken': csrftoken
                    }
                },
                columns: [
                    { 
                        data: 'date',
                        render: function(data) {
                            // Parse as local date, not UTC
                            const [year, month, day] = data.split('-');
                            return new Date(year, month - 1, day).toLocaleDateString();
                        }
                    },
                    /*{ 
                        data: 'total_sends',
                        render: $.fn.dataTable.render.number(',', '.', 0)
                    },*/
                    { 
                        data: 'total_deliveries',
                        render: $.fn.dataTable.render.number(',', '.', 0)
                    },
                    { 
                        data: 'total_bounces',
                        render: function(data, type, row) {
                            if (data > 0) {
                                // Create clickable link to bounces page with date filter
                                return '<a href="/ses/webhooks/sns/bounces-complaints/?date=' + row.date + '&tab=bounces">' + 
                                       data.toLocaleString('en-US') + '</a>';
                            }
                            return data.toLocaleString('en-US');
                        }
                    },
                    { 
                        data: 'total_complaints',
                        render: function(data, type, row) {
                            if (data > 0) {
                                // Create clickable link to complaints page with date filter
                                return '<a href="/ses/webhooks/sns/bounces-complaints/?date=' + row.date + '&tab=complaints">' + 
                                       data.toLocaleString('en-US') + '</a>';
                            }
                            return data.toLocaleString('en-US');
                        }
                    },
                    { 
                        data: 'bounce_rate',
                        render: function(data, type, row) {
                            var rate = parseFloat(data);
                            var cssClass = '';
                            
                            if (rate < 2) {
                                cssClass = 'rate-good';
                            } else if (rate < 5) {
                                cssClass = 'rate-warning';
                            } else {
                                cssClass = 'rate-danger';
                            }
                            
                            return '<span class="' + cssClass + '">' + rate.toFixed(2) + '%</span>';
                        }
                    },
                    { 
                        data: 'complaint_rate',
                        render: function(data, type, row) {
                            var rate = parseFloat(data);
                            var cssClass = '';
                            
                            if (rate < 0.1) {
                                cssClass = 'rate-good';
                            } else if (rate < 0.5) {
                                cssClass = 'rate-warning';
                            } else {
                                cssClass = 'rate-danger';
                            }
                            
                            return '<span class="' + cssClass + '">' + rate.toFixed(2) + '%</span>';
                        }
                    },
                    /*{ 
                        data: 'delivery_rate',
                        render: function(data, type, row) {
                            var rate = parseFloat(data);
                            var cssClass = '';
                            
                            if (rate > 95) {
                                cssClass = 'rate-good';
                            } else if (rate > 90) {
                                cssClass = 'rate-warning';
                            } else {
                                cssClass = 'rate-danger';
                            }
                            
                            return '<span class="' + cssClass + '">' + rate.toFixed(2) + '%</span>';
                        }
                    },*/
                    { 
                        data: 'unique_recipients',
                        render: $.fn.dataTable.render.number(',', '.', 0)
                    }
                ],
                order: [[0, 'desc']], // Default sort by date descending
                pageLength: 25,
                lengthMenu: [[10, 25, 50, 100], [10, 25, 50, 100]]
            });
            
            // Filter button click handler
            $('#filterBtn').on('click', function() {
                table.ajax.reload();
            });
            
            // Allow Enter key to trigger filter
            $('#startDate, #endDate').on('keypress', function(e) {
                if (e.which === 13) {
                    table.ajax.reload();
                }
            });
        });
    </script>
                            </div>
                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                </div>
            </div>

        <script>

        </script>
    </div>
</main>
{% endblock %}